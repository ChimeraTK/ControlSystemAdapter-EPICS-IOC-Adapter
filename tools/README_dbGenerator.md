# dbGenerator
Tool to generate EPICS databases from ChimeraTK variable households using configuration files 

## Syntax

dbGenerator *config_file* [-g *ChimeraTK_file*] [-l *logfile*]
* ***config_file***: Path to config file to be processed or generated
* ***ChimeraTK_file***: Path to ChimeraTK variable household file, generated by *application*-server-xmlGenerator. Triggers config file generation.
* ***logfile***: Path to logfile. If a file exists, new log is appended.

## Usage

To generate config file template "SomeServerConfig.xml" from existing ChimeraTK variable household "../../SomeServer.xml":

`dbGenerator SomeServerConfig.xml -g ../../SomeServer.xml`

This generates a config file in the current directory, based on the variables found in the source file.
- Aliases are automatically generated.
- PV names are generated from the "paths" in the source file.
- The record type is determined, based on direction, value type and number of elements of the ChimeraTK variable.

To generate EPICS-db, autosave-req and documentation files from "SomeServerConfig.xml":

`dbGenerator SomeServerConfig.xml`

This generates those files, as defined in config file.

## Config file

The configuration to generate the EPICS database is hold in an xml file.

### Example config file

```xml
<?xml version="1.0" encoding="UTF-8"?>
<EPICSdb application="SomeServer" xmlns="https://github.com/ChimeraTK/ControlSystemAdapter-EPICS-IOC-Adapter">
    <sourcefile label="sourceLabel" path="path/to/sourcefile.xml" type="xml-variables">
        <alias handle="Handle1" surrogate="path/" />
        <alias handle="Handle2" surrogate="to/" />
        <alias handle="VarPath" surrogate="+{Handle1}+{Handle2}" />
    </sourcefile>
    <outputfile macroReserve="5" path="path/to/database.db" autosavePath="path/to/autosave.req" autosave="true/false">
        <field type="FIELDTYPE" value="FIELDVALUE"/>
        <recordgroup type="recordtype" autosave="true/false">
            <field type="FIELDTYPE" value="FIELDVALUE"/>
            <record pvName="SomePVName" source="sourceLabel.+{VarPath}VarName" autosave="true/false">
                <field type="FIELDTYPE" value="+{:variable_attribute}"/>
            </record>
            <record pvName="SomeOtherPVName" source="sourceLabel.+{VarPath}OtherVarName"/>
        </recordgroup>
    </outputfile>
</EPICSdb>
```

### Config file elements

* `<sourcefile>`: Defines file(s), from which the data for the database have to be extracted.
  * `label`: Identifier to reference the source by.
  * `path`: Path to source file. May be relative or absolute.
  * `type`: Type of source file. Only "xml-variables" is supported, right now.
* `<alias>`: Subelement of `<sourcefile>`. Defines string substitution pairs. Allows abstraction of ChimeraTK variable-tree structure to apply changes in that structure more easy.
  * `handle`: String to be substituted, if found between `+{` and `}`.
  * `surrogate`: String to substitute. Can itself be alias.
  Aliases are resolved, until no more `+{}`-parantheses are found. Hence `<alias handle="string" surrogate="+{string}"/>` leads to infinite recursion.
* `<outputfile>`: Defines the file, to write the database, defined in its subelements, to.
  * `path`: Path to write the EPICS-db file to. May be a relative or absolute path.
  * `autosave`: Determines, if PVs in this file are added to autosave-req file. 
  * `autosavePath`: Path to write autosave-req file to. If not given, it is written to the same location as the db file, but with exchanged suffix.
  * `macroReserve`: Number of characters to be reserved on PV name for macro. Used in PV name length check.
* `<recordgroup>`: Subelement of `<outputfile>`. Groups EPICS records of the same record type together.
  * `type`: EPICS record type of the `<record>` subelements of this `<recordgroup>.
  * `autosave`: Determines, if PVs in this recordgroup are added to autosave-req file. Overrides file setting.
* `<record>`: Subelement of `<recordgroup>`. Defines a single record in the EPICS database.
  * `pvName`: Name of the PV, defined by the record. String is **not** expanded.
  * `source`: Refers to a sourcefile and a variable in it. The string before the dot has to refer to a `<sourcefile>`-element `label` attribute. The string after the dot will be expanded, using the aliases defined in the referred `<sourcefile>` element. The result should serve as a unique address to an entry in the sourcefile. If the part before the dot is omitted (including the dot), the string will not be expanded or utilized as an address.
  * `autosave`: Determines, if PVs in this record are added to autosave-req file. Overrides recordgroup and file setting.
* `<field>`: Subelement of either `<outputfile>`, `<recordgroup>` or `<record>`. Defines a field of an EPICS record. Fields are defined for all records in their level, possibly overriding fields defined in higher levels.
  * `type`: EPICS field type. String is **not** expanded.
  * `value`: EPICS field value. String is expanded. If the handle starts with a colon, it is treated as a link to a field in the source entry, defined in `source` attribute of `<record>` element.
    * For xml variable files, the following links are available:
      * `value_type`
      * `direction`
      * `unit`
      * `numberOfElements`
      * `description`
      * `address`
      * `variablePath`
      * `variableName`